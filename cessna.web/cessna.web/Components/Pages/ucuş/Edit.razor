@page "/ucus/edit/{id:int}"
@rendermode InteractiveServer

@using cessna.web.Models
@using Microsoft.EntityFrameworkCore
@inject CessnasContext Db
@inject NavigationManager Nav

<h3>Edit Flight</h3>

@if (!string.IsNullOrEmpty(Hata))
{
    <div class="alert alert-danger">
        @Hata
    </div>
}

@if (Model == null)
{
    <p>Loading...</p>
}
else
{
    <EditForm Model="Model"
              OnValidSubmit="Save"
              FormName="EditFlightForm">

        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label>Flight No</label>
            <InputText class="form-control"
                       @bind-Value="Model.UcusNo" />
        </div>

        <div class="mb-3">
            <label>Status</label>
            <InputText class="form-control"
                       @bind-Value="Model.Durum" />
        </div>

        <div class="mb-3">
            <label>Departure (Date & Time)</label>
            <input type="datetime-local"
                   class="form-control"
                   @bind="Model.KalkisZamani"
                   @bind:format="yyyy-MM-ddTHH:mm" />
        </div>

        <div class="mb-3">
            <label>Arrival (Date & Time)</label>
            <input type="datetime-local"
                   class="form-control"
                   @bind="Model.VarisZamani"
                   @bind:format="yyyy-MM-ddTHH:mm" />
        </div>

        <button type="submit" class="btn btn-primary">
            Save
        </button>

        <a class="btn btn-secondary ms-2" href="/ucus">
            Cancel
        </a>
    </EditForm>
}

@code {
    [Parameter] public int id { get; set; }

    Ucu? Model;
    string? Hata;

    protected override async Task OnInitializedAsync()
    {
        Model = await Db.Set<Ucu>()
                        .FirstOrDefaultAsync(x => x.UcusKod == id);

        if (Model == null)
        {
            Hata = "Flight not found.";
        }
    }

    async Task Save()
    {
        if (Model == null)
            return;

        if (Model.KalkisZamani == null || Model.VarisZamani == null)
        {
            Hata = "Dates are required.";
            return;
        }

        if (Model.VarisZamani <= Model.KalkisZamani)
        {
            Hata = "Arrival must be later than departure.";
            return;
        }

        await Db.SaveChangesAsync();

        Nav.NavigateTo("/ucus", forceLoad: true);
    }
}

