@page "/yakit/edit/{id:int}"
@rendermode InteractiveServer

@using cessna.web.Models
@using Microsoft.EntityFrameworkCore
@inject CessnasContext Db
@inject NavigationManager Nav

<h3>Edit Fuel Record</h3>

@if (!string.IsNullOrEmpty(Hata))
{
    <div class="alert alert-danger">@Hata</div>
}

@if (Model == null)
{
    <p>Loading...</p>
}
else
{
    <div class="mb-3">
        <label>Flight</label>
        <select class="form-select" @bind="Model.UcusKod">
            @foreach (var u in Ucuslar)
            {
                <option value="@u.UcusKod">@u.UcusNo</option>
            }
        </select>
    </div>

    <div class="mb-3">
        <label>Technician</label>
        <select class="form-select" @bind="Model.TeknisyenKod">
            @foreach (var t in Teknisyenler)
            {
                <option value="@t.TeknisyenKod">@t.AdSoyad</option>
            }
        </select>
    </div>

    <div class="mb-3">
        <label>Fuel Amount (L)</label>
        <input type="number" step="0.01" class="form-control" @bind="Model.MiktarLitre" />
    </div>

    <div class="mb-3">
        <label>Unit Price</label>
        <input type="number" step="0.01" class="form-control" @bind="Model.BirimFiyat" />
    </div>

    <button class="btn btn-primary" @onclick="Save">Save</button>
    <a class="btn btn-secondary ms-2" href="/yakit">Cancel</a>
}

@code {
    [Parameter] public int id { get; set; }

    Yakit? Model;
    string? Hata;

    List<Ucu> Ucuslar = new();
    List<Teknisyen> Teknisyenler = new();

    protected override async Task OnInitializedAsync()
    {
        Model = await Db.Set<Yakit>().FindAsync(id);

        if (Model == null)
        {
            Hata = "Fuel record not found.";
            return;
        }

        Ucuslar = await Db.Set<Ucu>().AsNoTracking().OrderBy(x => x.UcusNo).ToListAsync();
        Teknisyenler = await Db.Set<Teknisyen>().AsNoTracking().OrderBy(x => x.AdSoyad).ToListAsync();
    }

    async Task Save()
    {
        if (Model == null) return;

        if (Model.MiktarLitre == null || Model.MiktarLitre <= 0)
        {
            Hata = "Fuel amount must be greater than 0.";
            return;
        }

        if (Model.BirimFiyat == null || Model.BirimFiyat <= 0)
        {
            Hata = "Unit price must be greater than 0.";
            return;
        }

        await Db.SaveChangesAsync();
        Nav.NavigateTo("/yakit", true);
    }
}
